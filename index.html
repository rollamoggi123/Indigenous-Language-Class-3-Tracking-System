import React, { useState, useEffect } from 'react';
import { 
    Plus, Trash2, RotateCcw, CheckCircle, XCircle, Users, 
    ClipboardCheck, Upload, X, Eraser, Code, Copy, Info, 
    MapPin, User, GraduationCap, Calendar, Clock, AlertCircle, 
    FileText, Image, ExternalLink, Cloud 
} from 'lucide-react';

// ğŸ”¹ å¼•å…¥ Firebase åŠŸèƒ½ (ä½¿ç”¨ ES Module)
import { initializeApp } from "firebase/app";
import { 
    getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, deleteDoc, query 
} from "firebase/firestore";
import { 
    getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken 
} from "firebase/auth";

// ==========================================
// ğŸ”‘ åˆå§‹åŒ– Firebase (ä½¿ç”¨å¹³å°ç’°å¢ƒè®Šæ•¸)
// ==========================================
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// å®šç¾©é›†åˆåç¨± (æ–¹ä¾¿ç®¡ç†)
const COLLECTION_NAME = 'students';

const IndigenousLanguageTracker = () => {
    // ==========================================
    // ğŸ“ åˆå§‹åå–®è³‡æ–™ (å®Œæ•´ 17 ä½å­¸ç”Ÿ)
    // ==========================================
    const initialData = [
        { id: 1, name: "å²ç¿", studentId: "11106210", regular: false, midterm: false, final0102: false, final0109: false, oral: false, needsRevision: false, note: "" },
        { id: 2, name: "ç‹å¦¤å›", studentId: "11206201", regular: false, midterm: false, final0102: false, final0109: false, oral: false, needsRevision: false, note: "" },
        { id: 3, name: "å»–äºå¯°", studentId: "11206202", regular: false, midterm: false, final0102: false, final0109: false, oral: false, needsRevision: false, note: "" },
        { id: 4, name: "èƒ¡å¼˜æ˜“", studentId: "11206203", regular: false, midterm: false, final0102: false, final0109: false, oral: false, needsRevision: false, note: "" },
        { id: 5, name: "å‘‚é Œæ©", studentId: "11206210", regular: false, midterm: false, final0102: false, final0109: false, oral: false, needsRevision: false, note: "" },
        { id: 6, name: "æ¥Šèˆ’é–‘", studentId: "11206212", regular: false, midterm: false, final0102: false, final0109: false, oral: false, needsRevision: false, note: "" },
        { id: 7, name: "è‘£éŸ‹èª ", studentId: "11206214", regular: false, midterm: false, final0102: false, final0109: false, oral: false, needsRevision: false, note: "" },
        { id: 8, name: "è˜‡é‚±ç«‹å®", studentId: "11206215", regular: false, midterm: false, final0102: false, final0109: false, oral: false, needsRevision: false, note: "" },
        { id: 9, name: "æ—å­å«ˆ", studentId: "11206217", regular: false, midterm: false, final0102: false, final0109: false, oral: false, needsRevision: false, note: "" },
        { id: 10, name: "æ—èŠ³å®‡", studentId: "11206221", regular: false, midterm: false, final0102: false, final0109: false, oral: false, needsRevision: false, note: "" },
        { id: 11, name: "æ—è©©æ™¨", studentId: "11206222", regular: false, midterm: false, final0102: false, final0109: false, oral: false, needsRevision: false, note: "" },
        { id: 12, name: "é­ç¿”æ…§", studentId: "11206224", regular: false, midterm: false, final0102: false, final0109: false, oral: false, needsRevision: false, note: "" },
        { id: 13, name: "é»ƒæ¹˜èŒ¹", studentId: "11206225", regular: false, midterm: false, final0102: false, final0109: false, oral: false, needsRevision: false, note: "" },
        { id: 14, name: "ä½™æ™¨å„€", studentId: "11206226", regular: false, midterm: false, final0102: false, final0109: false, oral: false, needsRevision: false, note: "" },
        { id: 15, name: "è‘›é›¯", studentId: "11206227", regular: false, midterm: false, final0102: false, final0109: false, oral: false, needsRevision: false, note: "" },
        { id: 16, name: "æ—å­å«£", studentId: "11206230", regular: false, midterm: false, final0102: false, final0109: false, oral: false, needsRevision: false, note: "" },
        { id: 17, name: "Malinda", studentId: "", regular: false, midterm: false, final0102: false, final0109: false, oral: false, needsRevision: false, note: "" },
    ];

    const [user, setUser] = useState(null);
    const [students, setStudents] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [errorInfo, setErrorInfo] = useState(null);

    const [newStudentName, setNewStudentName] = useState('');
    const [newStudentId, setNewStudentId] = useState('');
    const [showImportModal, setShowImportModal] = useState(false);
    const [importText, setImportText] = useState('');

    // ğŸ”¹ 1. è™•ç†ä½¿ç”¨è€…ç™»å…¥ (Firebase Auth)
    useEffect(() => {
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                setErrorInfo({ title: "é©—è­‰éŒ¯èª¤", desc: "ç„¡æ³•ç™»å…¥ç³»çµ±ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚" });
            }
        };
        initAuth();

        const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
            setUser(currentUser);
        });
        return () => unsubscribe();
    }, []);

    // ğŸ”¹ 2. ç›£è½ Firestore è³‡æ–™åº«è®ŠåŒ– (Public Data)
    useEffect(() => {
        if (!user) return;

        // ä½¿ç”¨ç¬¦åˆè¦å®šçš„è·¯å¾‘: artifacts/{appId}/public/data/{collectionName}
        const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
        const q = query(collectionRef); // ä¸ä½¿ç”¨è¤‡é›œçš„ orderByï¼Œæ”¹åœ¨å‰ç«¯æ’åº

        const unsubscribe = onSnapshot(q, 
            (snapshot) => {
                const studentsData = snapshot.docs.map(doc => ({
                    id: doc.id, // ä½¿ç”¨ string ID
                    ...doc.data()
                }));
                
                // åœ¨å‰ç«¯é€²è¡Œæ’åº (ä¾ç…§ id è½‰æ•¸å­—å¾Œæ’åº)
                studentsData.sort((a, b) => Number(a.id) - Number(b.id));
                
                setStudents(studentsData);
                setIsLoading(false);
                setErrorInfo(null);
            }, 
            (error) => {
                console.error("è®€å–è³‡æ–™å¤±æ•—:", error);
                setErrorInfo({
                    title: "è³‡æ–™è®€å–éŒ¯èª¤",
                    desc: "ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚"
                });
                setIsLoading(false);
            }
        );

        return () => unsubscribe();
    }, [user]);

    // ğŸ”¹ Helper: å–å¾—æ–‡ä»¶åƒç…§
    const getStudentDoc = (id) => doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, id.toString());

    // ğŸ”¹ åˆ‡æ›ç‹€æ…‹
    const toggleStatus = async (id, field) => {
        const student = students.find(s => s.id === id);
        if (!student) return;
        try {
            await updateDoc(getStudentDoc(id), { [field]: !student[field] });
        } catch (e) { alert("æ›´æ–°å¤±æ•—ï¼š" + e.message); }
    };

    // ğŸ”¹ æ›´æ–°å‚™è¨»
    const handleNoteBlur = async (id, currentVal) => {
        try {
            await updateDoc(getStudentDoc(id), { note: currentVal });
        } catch (e) { console.error("å‚™è¨»æ›´æ–°å¤±æ•—", e); }
    };

    // ğŸ”¹ æ–°å¢å­¸ç”Ÿ
    const addStudent = async (e) => {
        e.preventDefault();
        if (!newStudentName.trim()) return;
        
        const newId = Date.now();
        const newStudent = {
            id: newId,
            name: newStudentName,
            studentId: newStudentId,
            regular: false, midterm: false, final0102: false, final0109: false, oral: false, needsRevision: false, note: ""
        };
        
        try {
            await setDoc(getStudentDoc(newId), newStudent);
            setNewStudentName(''); setNewStudentId('');
        } catch (e) { alert("æ–°å¢å¤±æ•—ï¼š" + e.message); }
    };

    // ğŸ”¹ æ‰¹é‡åŒ¯å…¥
    const handleBulkImport = async () => {
        if (!importText.trim()) return;
        const lines = importText.trim().split('\n');
        let count = 0;
        
        // ç‚ºäº†é¿å…åŒæ™‚å¯«å…¥è¡çªï¼Œä½¿ç”¨ç°¡å–®çš„å»¶é²æˆ– Promise.all
        const promises = [];

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            const parts = line.trim().split(/[\s,ï¼Œ\t]+/);
            const name = parts[0];
            const studentId = parts.length > 1 ? parts[1] : '';
            if (!name) continue;

            const newId = Date.now() + i;
            const newStudent = {
                id: newId, name: name, studentId: studentId,
                regular: false, midterm: false, final0102: false, final0109: false, oral: false, needsRevision: false, note: ""
            };
            
            promises.push(setDoc(getStudentDoc(newId), newStudent));
            count++;
        }

        try {
            await Promise.all(promises);
            alert(`æˆåŠŸåŒ¯å…¥ ${count} ç­†è³‡æ–™ï¼`);
            setImportText(''); setShowImportModal(false);
        } catch (e) {
            alert("åŒ¯å…¥å¤±æ•—: " + e.message);
        }
    };

    // ğŸ”¹ åˆªé™¤
    const deleteStudent = async (id) => {
        if (window.confirm('ç¢ºå®šè¦åˆªé™¤é€™ä½å­¸ç”Ÿå—ï¼Ÿ')) {
            try {
                await deleteDoc(getStudentDoc(id));
            } catch (e) {
                alert("åˆªé™¤å¤±æ•—: " + e.message);
            }
        }
    };

    // ğŸ”¹ åˆå§‹åŒ–è³‡æ–™åº«
    const uploadInitialData = async () => {
        if (!window.confirm("ç¢ºå®šè¦åˆå§‹åŒ–è³‡æ–™åº«å—ï¼Ÿå°‡å¯«å…¥ 17 ä½å­¸ç”Ÿåå–®ã€‚")) return;
        setIsLoading(true);
        try {
            const promises = initialData.map(student => 
                setDoc(getStudentDoc(student.id), student)
            );
            await Promise.all(promises);
            alert("âœ… åˆå§‹åŒ–å®Œæˆï¼");
        } catch (e) { alert("âŒ åˆå§‹åŒ–å¤±æ•—ï¼š" + e.message); }
        setIsLoading(false);
    };

    // ğŸ”¹ æ¸…ç©º
    const clearAllData = async () => {
        if (!window.confirm('ç¢ºå®šè¦æ¸…ç©ºã€Œæ‰€æœ‰ã€é›²ç«¯è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;
        setIsLoading(true);
        try {
            const batchPromises = students.map(s => deleteDoc(getStudentDoc(s.id)));
            await Promise.all(batchPromises);
        } catch (e) {
            alert("æ¸…ç©ºå¤±æ•—: " + e.message);
        }
        setIsLoading(false);
    };

    const checkPass = (s) => {
        const finals = s.final0102 || s.final0109;
        const required = s.regular && s.midterm && s.oral && finals;
        return required;
    };

    const stats = {
        total: students.length,
        passed: students.filter(checkPass).length,
        pending: students.filter(s => !checkPass(s)).length
    };

    // éŒ¯èª¤è™•ç†ç•«é¢
    if (errorInfo) {
        return (
            <div className="min-h-screen flex flex-col items-center justify-center text-red-600 gap-4 p-4 bg-red-50">
                <AlertCircle size={48} />
                <div className="text-xl font-bold">é€£ç·šéŒ¯èª¤ (Connection Error)</div>
                <div className="bg-white p-6 rounded-lg shadow-md max-w-lg border border-red-200">
                    <p className="font-bold mb-2 text-lg text-red-700">{errorInfo.title}</p>
                    <p className="mb-4 text-stone-700 leading-relaxed">{errorInfo.desc}</p>
                </div>
            </div>
        );
    }

    if (isLoading && students.length === 0) {
        return <div className="min-h-screen flex items-center justify-center text-stone-500 font-bold bg-stone-50">
            <div className="animate-pulse flex flex-col items-center gap-2">
                <Cloud className="w-8 h-8 text-teal-500" />
                <span>è¼‰å…¥é›²ç«¯è³‡æ–™ä¸­... (Loading Cloud Data...)</span>
            </div>
        </div>;
    }

    return (
        <div className="min-h-screen bg-stone-50 p-4 md:p-8 font-sans text-stone-800">
            <div className="max-w-7xl mx-auto relative">
                
                {/* Header & Course Info */}
                <header className="mb-6 bg-white p-6 rounded-2xl shadow-sm border border-stone-200">
                    <div className="flex flex-col gap-4">
                        <div className="border-b border-stone-100 pb-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <h1 className="text-2xl md:text-3xl font-bold text-teal-800 flex items-center gap-3">
                                    <ClipboardCheck className="w-8 h-8 flex-shrink-0" />
                                    <div>
                                        <div>æ—èª 3 èª²ç¨‹è¿½è¹¤ç³»çµ± (é›²ç«¯ç‰ˆ)</div>
                                        <div className="text-lg md:text-xl font-medium text-teal-600 mt-1">
                                            Indigenous Language Class 3 Tracking System
                                        </div>
                                    </div>
                                </h1>
                                <div className="flex items-center gap-2 mt-2 ml-11">
                                    <span className="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full flex items-center gap-1 font-bold">
                                        <Cloud size={12}/> Cloud Sync Active
                                    </span>
                                    {user && <span className="text-xs text-stone-400 font-mono">ID: {user.uid.slice(0,6)}...</span>}
                                </div>
                            </div>
                            
                            {/* åˆå§‹åŒ–æŒ‰éˆ• */}
                            {students.length === 0 && (
                                <button 
                                    onClick={uploadInitialData}
                                    className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg shadow-lg animate-pulse font-bold flex items-center gap-2"
                                >
                                    <Upload size={20} /> ğŸš€ åˆå§‹åŒ–/ä¸Šå‚³ 17 ç­†é è¨­åå–®
                                </button>
                            )}
                        </div>

                        {/* Course Details Grid */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 ml-0 md:ml-11 text-sm md:text-base">
                            <div className="flex items-center gap-2 text-stone-700">
                                <User className="w-5 h-5 text-indigo-500" />
                                <div>
                                    <div className="text-xs text-stone-400">æˆèª²æ•™å¸« Instructor</div>
                                    <div className="font-bold">è˜¿æ‹‰éº»å‰ Sonay Rolla Moggi</div>
                                </div>
                            </div>
                            <div className="flex items-center gap-2 text-stone-700">
                                <GraduationCap className="w-5 h-5 text-indigo-500" />
                                <div>
                                    <div className="text-xs text-stone-400">ç­ç´š Class</div>
                                    <div className="font-bold">å¹¼æ•™ç³» Dept. of ECE</div>
                                </div>
                            </div>
                            <div className="flex items-center gap-2 text-stone-700">
                                <MapPin className="w-5 h-5 text-indigo-500" />
                                <div>
                                    <div className="text-xs text-stone-400">åœ°é» Location</div>
                                    <div className="font-bold">A103 èªæ–‡æ•™å®¤</div>
                                </div>
                            </div>
                        </div>

                        {/* Notices */}
                        <div className="mt-2 bg-amber-50 border-l-4 border-amber-400 p-4 rounded-r-lg ml-0 md:ml-11">
                            <div className="flex items-start gap-3">
                                <Info className="w-6 h-6 text-amber-600 flex-shrink-0 mt-1" />
                                <div className="text-sm md:text-base text-amber-900">
                                    <div className="font-bold mb-1 text-lg">ğŸ“¢ è£œè€ƒèˆ‡è£œäº¤èªªæ˜ / Make-up Exam Notice</div>
                                    <p className="mb-2">
                                        å…è¨±å­¸ç”Ÿè£œäº¤å ±å‘ŠåŠå£èªªæ¸¬é©—(è£œè€ƒ)ä¸¦ä¸Šå‚³éŒ„éŸ³æª”ã€‚
                                    </p>
                                    <div className="flex flex-wrap items-center gap-x-4 gap-y-1 font-bold text-amber-800 bg-amber-100/50 p-2 rounded-lg">
                                        <span className="flex items-center gap-1"><Calendar size={16}/> 01/09 æœŸæœ« Final</span>
                                        <span className="flex items-center gap-1"><Clock size={16}/> 14:10 é–‹å§‹ Start</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Reference Examples */}
                        <div className="mt-4 pt-3 border-t border-indigo-200">
                            <div className="font-bold text-indigo-800 mb-3 flex items-center gap-2">
                                <Info size={16} /> ç„¦é»ç³»çµ±åƒè€ƒç¯„ä¾‹ (Focus System Examples)
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="bg-white/60 p-2 rounded-lg border border-indigo-100">
                                    <div className="font-bold text-indigo-700 mb-1">é˜¿ç¾èª (Amis) - ç’°ç¶´</div>
                                    <div className="flex flex-wrap gap-2">
                                        <a href="https://res.cloudinary.com/dm1ksvptk/image/upload/v1767762146/%E9%98%BF%E7%BE%8E%E8%AA%9E%E4%B8%BB%E7%84%A6%E7%92%B0%E7%B6%B4%E4%BE%8B_ymulgj.jpg" target="_blank" className="text-blue-600 text-xs flex items-center gap-1 hover:underline bg-white px-2 py-1 rounded border border-indigo-100"><Image size={14}/> ç¯„ä¾‹åœ– 1</a>
                                        <a href="https://res.cloudinary.com/dm1ksvptk/image/upload/v1767762158/%E8%8B%B1%E6%96%87%E7%89%88_%E9%98%BF%E7%BE%8E%E8%AA%9E%E4%B8%BB%E7%84%A6%E7%92%B0%E7%B6%B4%E4%BE%8B_tsts15.jpg" target="_blank" className="text-blue-600 text-xs flex items-center gap-1 hover:underline bg-white px-2 py-1 rounded border border-indigo-100"><Image size={14}/> ç¯„ä¾‹åœ– 2</a>
                                    </div>
                                </div>
                                <div className="bg-white/60 p-2 rounded-lg border border-indigo-100">
                                    <div className="font-bold text-indigo-700 mb-1">æ±æ’ç£èª - ä¸­ç¶´</div>
                                    <a href="https://res.cloudinary.com/dm1ksvptk/image/upload/v1767760755/%E8%9E%A2%E5%B9%95%E6%93%B7%E5%8F%96%E7%95%AB%E9%9D%A2_2026-01-07_115655_g0zgje.png" target="_blank" className="text-blue-600 text-xs flex items-center gap-1 hover:underline bg-white px-2 py-1 rounded border border-indigo-100"><Image size={14}/> ç¯„ä¾‹åœ–</a>
                                </div>
                                <div className="bg-white/60 p-2 rounded-lg border border-indigo-100">
                                    <div className="font-bold text-indigo-700 mb-1">æ’’å¥‡èŠé›…èª - å·¥å…·ç„¦é»</div>
                                    <a href="https://res.cloudinary.com/dm1ksvptk/image/upload/v1767763646/%E8%9E%A2%E5%B9%95%E6%93%B7%E5%8F%96%E7%95%AB%E9%9D%A2_2026-01-07_132613_s88rlt.png" target="_blank" className="text-blue-600 text-xs flex items-center gap-1 hover:underline bg-white px-2 py-1 rounded border border-indigo-100"><Image size={14}/> ç¯„ä¾‹åœ–</a>
                                </div>
                                <div className="bg-white/60 p-2 rounded-lg border border-indigo-100">
                                    <div className="font-bold text-indigo-700 mb-1">å¸ƒè¾²æ—éƒ¡ç¾¤ - ä¸»äº‹ç„¦é»</div>
                                    <a href="https://res.cloudinary.com/dm1ksvptk/image/upload/v1767773306/%E8%9E%A2%E5%B9%95%E6%93%B7%E5%8F%96%E7%95%AB%E9%9D%A2_2026-01-07_160659_vmyfug.png" target="_blank" className="text-blue-600 text-xs flex items-center gap-1 hover:underline bg-white px-2 py-1 rounded border border-indigo-100"><Image size={14}/> ç¯„ä¾‹åœ–</a>
                                </div>
                                <div className="bg-white/60 p-2 rounded-lg border border-indigo-100">
                                    <div className="font-bold text-indigo-700 mb-1">å¤ªé­¯é–£èª - å‰ç¶´</div>
                                    <a href="https://res.cloudinary.com/dm1ksvptk/image/upload/v1767758597/%E8%9E%A2%E5%B9%95%E6%93%B7%E5%8F%96%E7%95%AB%E9%9D%A2_2026-01-07_120039_zjhpcn.png" target="_blank" className="text-blue-600 text-xs flex items-center gap-1 hover:underline bg-white px-2 py-1 rounded border border-indigo-100"><Image size={14}/> ç¯„ä¾‹åœ–</a>
                                </div>
                            </div>
                        </div>
                        
                        {/* Statistics */}
                        <div className="flex flex-wrap gap-3 mt-4 justify-end">
                            <div className="bg-blue-50 px-4 py-2 rounded-lg text-center flex-1 md:flex-none">
                                <div className="text-xs text-blue-600 font-bold uppercase">Total</div>
                                <div className="text-xl font-bold text-blue-800">{stats.total}</div>
                            </div>
                            <div className="bg-green-50 px-4 py-2 rounded-lg text-center flex-1 md:flex-none">
                                <div className="text-xs text-green-600 font-bold uppercase">Passed</div>
                                <div className="text-xl font-bold text-green-800">{stats.passed}</div>
                            </div>
                            <div className="bg-orange-50 px-4 py-2 rounded-lg text-center flex-1 md:flex-none">
                                <div className="text-xs text-orange-600 font-bold uppercase">Pending</div>
                                <div className="text-xl font-bold text-orange-800">{stats.pending}</div>
                            </div>
                        </div>

                    </div>
                </header>

                {/* Main Table */}
                <div className="bg-white rounded-2xl shadow-lg border border-stone-200 overflow-hidden">
                    <div className="overflow-x-auto">
                        <table className="w-full text-left border-collapse">
                            <thead>
                                <tr className="bg-teal-700 text-white text-sm md:text-base">
                                    <th className="p-3 md:p-4 font-semibold w-12 text-center">#</th>
                                    <th className="p-3 md:p-4 font-semibold min-w-[140px]">
                                        <div>å§“å / å­¸è™Ÿ</div>
                                        <div className="text-xs text-teal-200 font-normal">Name / ID</div>
                                    </th>
                                    <th className="p-3 md:p-4 font-semibold text-center min-w-[90px]">
                                        <div>å¹³æ™‚</div>
                                        <div className="text-xs text-teal-200 font-normal">Regular</div>
                                    </th>
                                    <th className="p-3 md:p-4 font-semibold text-center min-w-[90px]">
                                        <div>æœŸä¸­</div>
                                        <div className="text-xs text-teal-200 font-normal">Midterm</div>
                                    </th>
                                    <th className="p-3 md:p-4 font-semibold text-center min-w-[90px] bg-teal-800">
                                        <div>æœŸæœ« I</div>
                                        <div className="text-xs text-teal-200 font-normal">Final I</div>
                                    </th>
                                    <th className="p-3 md:p-4 font-semibold text-center min-w-[90px] bg-teal-800 border-l border-teal-700">
                                        <div>æœŸæœ« II</div>
                                        <div className="text-xs text-teal-200 font-normal">Final II</div>
                                    </th>
                                    <th className="p-3 md:p-4 font-semibold text-center min-w-[90px] bg-indigo-700">
                                        <div>å£èªª</div>
                                        <div className="text-xs text-indigo-200 font-normal">Oral</div>
                                    </th>
                                    <th className="p-3 md:p-4 font-semibold text-center min-w-[90px] bg-amber-600">
                                        <div>éœ€ä¿®æ­£</div>
                                        <div className="text-xs text-amber-100 font-normal">Revise</div>
                                    </th>
                                    <th className="p-3 md:p-4 font-semibold text-center min-w-[100px]">
                                        <div>ç‹€æ…‹</div>
                                        <div className="text-xs text-teal-200 font-normal">Status</div>
                                    </th>
                                    <th className="p-3 md:p-4 font-semibold min-w-[160px]">
                                        <div>å‚™è¨»</div>
                                        <div className="text-xs text-teal-200 font-normal">Note</div>
                                    </th>
                                    <th className="p-3 md:p-4 font-semibold w-16 text-center">
                                        <div>æ“ä½œ</div>
                                        <div className="text-xs text-teal-200 font-normal">Action</div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody className="text-sm md:text-base">
                                {students.map((student, index) => {
                                    const isPassed = checkPass(student);
                                    return (
                                        <tr 
                                            key={student.id} 
                                            className={`border-b border-stone-100 hover:bg-stone-50 transition-colors ${isPassed ? 'bg-green-50/30' : ''}`}
                                        >
                                            <td className="p-3 md:p-4 text-center text-stone-500">{index + 1}</td>
                                            <td className="p-3 md:p-4">
                                                <div className="font-bold text-stone-800">{student.name}</div>
                                                <div className="text-sm text-stone-500 font-mono">{student.studentId}</div>
                                            </td>
                                            {['regular', 'midterm', 'final0102', 'final0109', 'oral'].map((field) => (
                                                <td key={field} className="p-3 md:p-4 text-center">
                                                    <button
                                                        onClick={() => toggleStatus(student.id, field)}
                                                        className={`p-2 rounded-full transition-all duration-200 ${
                                                            student[field] 
                                                                ? 'bg-green-100 text-green-600 hover:bg-green-200' 
                                                                : 'bg-stone-100 text-stone-300 hover:bg-stone-200'
                                                        }`}
                                                    >
                                                        {student[field] ? <CheckCircle size={24} /> : <XCircle size={24} />}
                                                    </button>
                                                </td>
                                            ))}
                                            <td className="p-3 md:p-4 text-center">
                                                <button
                                                    onClick={() => toggleStatus(student.id, 'needsRevision')}
                                                    className={`p-2 rounded-full transition-all duration-200 relative group ${
                                                        student.needsRevision 
                                                            ? 'bg-amber-100 text-amber-600 hover:bg-amber-200' 
                                                            : 'bg-stone-100 text-stone-300 hover:bg-stone-200'
                                                    }`}
                                                >
                                                    <RotateCcw size={24} />
                                                </button>
                                            </td>
                                            <td className="p-3 md:p-4 text-center">
                                                <span className={`inline-flex flex-col items-center px-3 py-1 rounded-lg text-xs font-bold border ${
                                                    isPassed 
                                                        ? 'bg-green-100 text-green-700 border-green-200' 
                                                        : 'bg-red-50 text-red-600 border-red-100'
                                                }`}>
                                                    <span>{isPassed ? 'é€šé' : 'æœªé€šé'}</span>
                                                    <span className="text-[10px] opacity-80 uppercase">{isPassed ? 'PASS' : 'FAIL'}</span>
                                                </span>
                                            </td>
                                            <td className="p-3 md:p-4">
                                                <input
                                                    type="text"
                                                    defaultValue={student.note}
                                                    onBlur={(e) => handleNoteBlur(student.id, e.target.value)}
                                                    placeholder="Ex: è£œè€ƒé †åº 1"
                                                    className="w-full bg-transparent border-b border-stone-200 focus:border-teal-500 focus:outline-none text-sm py-1 placeholder:text-stone-300"
                                                />
                                            </td>
                                            <td className="p-3 md:p-4 text-center">
                                                <button 
                                                    onClick={() => deleteStudent(student.id)}
                                                    className="text-stone-400 hover:text-red-500 transition-colors"
                                                >
                                                    <Trash2 size={18} />
                                                </button>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                        {students.length === 0 && !isLoading && (
                            <div className="p-12 text-center text-stone-400">
                                <Users className="w-12 h-12 mx-auto mb-3 opacity-50" />
                                <p>No data. (æš«ç„¡è³‡æ–™ï¼Œè«‹é»æ“Šä¸Šæ–¹çš„åˆå§‹åŒ–æŒ‰éˆ•)</p>
                            </div>
                        )}
                    </div>

                    {/* Footer Controls */}
                    <div className="bg-stone-50 p-6 border-t border-stone-200 flex flex-col xl:flex-row justify-between items-center gap-6">
                        <form onSubmit={addStudent} className="flex gap-3 w-full xl:w-auto">
                            <input type="text" placeholder="å§“å Name" value={newStudentName} onChange={(e) => setNewStudentName(e.target.value)} className="px-4 py-2 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-teal-500 shadow-sm flex-1 xl:flex-none w-32 md:w-auto" />
                            <input type="text" placeholder="å­¸è™Ÿ ID" value={newStudentId} onChange={(e) => setNewStudentId(e.target.value)} className="px-4 py-2 rounded-lg border border-stone-300 focus:outline-none focus:ring-2 focus:ring-teal-500 shadow-sm flex-1 xl:flex-none w-32 md:w-auto" />
                            <button type="submit" disabled={!newStudentName} className="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2 shadow-sm disabled:opacity-50"><Plus size={18} /> æ–°å¢ Add</button>
                        </form>
                        <div className="flex flex-wrap gap-2 md:gap-3 justify-center">
                            <button onClick={() => setShowImportModal(true)} className="flex items-center gap-2 px-3 md:px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors text-sm shadow-sm"><Upload size={16} /> æ‰¹é‡åŒ¯å…¥</button>
                            <div className="h-8 w-px bg-stone-300 mx-1 md:mx-2 hidden md:block"></div>
                            <button onClick={clearAllData} className="flex items-center gap-2 px-3 md:px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors text-sm"><Eraser size={16} /> æ¸…ç©º</button>
                        </div>
                    </div>
                </div>

                {/* Import Modal */}
                {showImportModal && (
                    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-2xl shadow-xl w-full max-w-lg overflow-hidden">
                            <div className="p-6 border-b border-stone-200 flex justify-between items-center">
                                <h3 className="text-xl font-bold text-stone-800 flex items-center gap-2"><Upload size={20} /> æ‰¹é‡åŒ¯å…¥åå–®</h3>
                                <button onClick={() => setShowImportModal(false)} className="text-stone-400 hover:text-stone-600"><X size={24} /></button>
                            </div>
                            <div className="p-6">
                                <p className="text-sm text-stone-500 mb-3">æ¯è¡Œä¸€ä½å­¸ç”Ÿã€‚æ ¼å¼ï¼šã€Œå§“åã€æˆ–ã€Œå§“å å­¸è™Ÿã€ã€‚</p>
                                <textarea className="w-full h-64 p-4 border border-stone-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-sm" placeholder={`Example:\nç‹å¤§æ˜ A11001\nJohn Doe A11002`} value={importText} onChange={(e) => setImportText(e.target.value)}></textarea>
                            </div>
                            <div className="p-6 border-t border-stone-200 bg-stone-50 flex justify-end gap-3">
                                <button onClick={() => setShowImportModal(false)} className="px-4 py-2 text-stone-600 hover:bg-stone-200 rounded-lg font-medium">Cancel</button>
                                <button onClick={handleBulkImport} className="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium shadow-sm">Import</button>
                            </div>
                        </div>
                    </div>
                )}

                <div className="mt-6 text-center text-stone-400 text-sm">
                    <p>æ—èª 3 èª²ç¨‹ç®¡ç†ç³»çµ± | Indigenous Language Class Tracker</p>
                </div>
            </div>
        </div>
    );
};

export default IndigenousLanguageTracker;
